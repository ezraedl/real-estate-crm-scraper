# HomeHarvest Status Analysis Results

## Test Date

Generated by: `test_homeharvest_statuses.py` and `test_specific_address.py`

## Key Findings

### 1. Status Values Returned by HomeHarvest

#### For `listing_type='for_sale'` (Bulk Location Queries):

- **`status` field values**: `FOR_SALE`, `PENDING`, `CONTINGENT`
- **`mls_status` field values**: `Active`, `Pending`
- **No off-market statuses found**: No `WITHDRAWN`, `EXPIRED`, `CANCELLED`, `OFF_MARKET`, etc.

#### For `listing_type='sold'`:

- **`status` field values**: `SOLD`
- **`mls_status` field values**: `Sold`

#### For `listing_type='pending'`:

- **`status` field values**: `PENDING`, `CONTINGENT`
- **`mls_status` field values**: `Pending`, `Active`

#### For `listing_type='for_rent'`:

- **`status` field values**: `FOR_RENT`
- **`mls_status` field values**: `Active`

### 2. CRITICAL DISCOVERY: Direct Address Queries Return Off-Market Properties!

**Test Result for `4509 E 10th St, Indianapolis, IN 46201`:**

- ✅ **Found when querying by specific address**
- ✅ **Status: `OFF_MARKET`**
- ✅ **MLS Status: `Expired`**
- ✅ **Appears in all `listing_type` queries** (for_sale, sold, pending, for_rent) when queried by address
- ❌ **Does NOT appear in bulk location queries** (e.g., "Indianapolis, IN")

**This means:**

- Off-market properties ARE accessible via direct address queries
- They have `status="OFF_MARKET"` and `mls_status="Expired"` (or similar)
- We CAN detect off-market status if we query properties directly by address

### 3. HomeHarvest Behavior

1. **Bulk location queries filter out off-market**: When querying by location (e.g., "Indianapolis, IN"), off-market properties are filtered out
2. **Direct address queries return all properties**: When querying by specific address, properties are returned regardless of status
3. **Off-market properties have proper status**: They show `status="OFF_MARKET"` and `mls_status` like "Expired", "Withdrawn", etc.

### 4. Test Results Summary

**Bulk Location Queries:**

```
listing_type='for_sale':    100 properties - Statuses: FOR_SALE (71), PENDING (28), CONTINGENT (1)
listing_type='sold':        100 properties - Statuses: SOLD (100)
listing_type='pending':     100 properties - Statuses: PENDING (97), CONTINGENT (3)
listing_type='for_rent':    100 properties - Statuses: FOR_RENT (100)
Without listing_type filter: 200 properties - Statuses: FOR_SALE (142), PENDING (57), CONTINGENT (1)
```

**Direct Address Query (`4509 E 10th St, Indianapolis, IN 46201`):**

```
Status: OFF_MARKET
MLS Status: Expired
List Price: $239,900
Sold Price: $49,500
Found in: for_sale, sold, pending, for_rent queries (when queried by address)
```

## Impact on Off-Market Detection

### Current Behavior

When a property is removed from the market (not sold):

1. It stops appearing in HomeHarvest bulk location queries (`for_sale`, `sold`, etc.)
2. Our scraper stops getting updates for it during normal scraping
3. The property appears to "disappear" from our system
4. However, **querying by specific address DOES return the property** with `OFF_MARKET` status

### Root Cause

- **HomeHarvest filters out off-market properties** from bulk location queries
- **Direct address queries DO return off-market properties** with proper status
- **Status change is invisible** during bulk scraping but detectable via direct address queries

## Recommended Solutions

### Option 1: Track Disappearing Properties + Direct Address Query (RECOMMENDED)

1. **Before each scrape**: Store list of `property_id`s that currently have `listing_type='for_sale'`
2. **After scrape**: Compare with previous list
3. **Detect missing properties**: Properties that were `for_sale` but no longer appear in bulk queries
4. **Query missing properties directly**: For each missing property, query HomeHarvest by specific address
5. **Check returned status**: If property is found with `status='OFF_MARKET'` or `mls_status` like 'Expired', 'Withdrawn', etc.
6. **Mark as OFF_MARKET**: Update their status in database to `OFF_MARKET`
7. **Track in history**: Record the status change in `property_history` or `change_logs`

**Advantages:**

- ✅ Confirms property still exists (not deleted)
- ✅ Gets actual status from HomeHarvest (`OFF_MARKET`, `Expired`, etc.)
- ✅ Accurate status detection

### Option 2: Periodic Re-scraping of Known Properties by Address

1. **Maintain a list** of all properties that were ever `for_sale`
2. **Periodically query each property** by address (not location)
3. **Check returned status**: Look for `status='OFF_MARKET'` or off-market `mls_status`
4. **Update status**: Mark as `OFF_MARKET` if found with off-market status

**Advantages:**

- ✅ Can catch properties that went off-market between bulk scrapes
- ✅ Gets accurate status from HomeHarvest

### Option 3: Track Disappearing Properties (Simpler, Less Accurate)

1. **Before each scrape**: Store list of `property_id`s that currently have `listing_type='for_sale'`
2. **After scrape**: Compare with previous list
3. **Detect missing properties**: Properties that were `for_sale` but no longer appear
4. **Mark as OFF_MARKET**: Update their status in database to `OFF_MARKET` (assume off-market)
5. **Track in history**: Record the status change

**Limitations:**

- ❌ Doesn't confirm property still exists
- ❌ Doesn't get actual status from HomeHarvest
- ❌ May mark properties as off-market incorrectly if they were sold or data issue

## Implementation Notes

### Status Values to Track

Based on MLS standards and HomeHarvest results, off-market statuses include:

- `OFF_MARKET` - General off-market status (from `status` field)
- `Expired` - Listing expired (from `mls_status` field)
- `Withdrawn` - Property withdrawn from market
- `Cancelled` - Listing cancelled
- `Temporarily Off Market` - Temporarily removed
- `Inactive` - No longer active
- `Delisted` - Removed from listing

**When querying by address**, HomeHarvest returns these statuses properly.

### Database Schema

The backend already supports `OFF_MARKET` status:

- `src/models/Property.ts` line 61: `status?: string; // Property status: "FOR_SALE", "PENDING", "SOLD", "FOR_RENT", "CONTINGENT", "OFF_MARKET"`
- `src/models/Property.ts` line 186: enum includes `'OFF_MARKET'`

## Next Steps

1. ✅ **Confirmed**: HomeHarvest filters out off-market properties from bulk queries
2. ✅ **Confirmed**: Direct address queries return off-market properties with proper status
3. ⏳ **Implement**: Disappearing property detection logic
4. ⏳ **Add**: Direct address query for missing properties
5. ⏳ **Add**: Status change tracking for properties that go off-market
6. ⏳ **Update**: Scraper to mark properties as `OFF_MARKET` when detected
